# Technical Design: HPM Dry Run & Validation

Этот документ описывает механизмы предварительной проверки конфигурации окружения перед его реальной сборкой.

## 1. Задача
Пользователь хочет убедиться, что выбранная комбинация групп и пакетов (например, `inference=vlm-adapter-qwen` + `metrics=accuracy`) совместима и может быть разрешена `uv`, не выполняя долгую установку.

## 2. Решение: `uv lock` как валидатор

`uv` не имеет явного флага `--dry-run` для команды `add`, но он имеет команду `uv lock`, которая разрешает зависимости и генерирует `uv.lock` файл, **не устанавливая** пакеты в окружение.

### 2.1. Workflow проверки (HPM Check)

Команда `hpm check` выполняет следующие действия:

1.  **Генерация временного манифеста**: HPM создает временный `pyproject.toml` в `.hpm/tmp/`, куда записывает все зависимости из текущего `hpm.yaml` (или выбранной конфигурации групп).
2.  **Запуск резолвера**: Выполняет `uv lock` в этой временной директории.
3.  **Анализ результата**:
    *   **Success (Exit Code 0)**: Зависимости разрешимы. HPM сообщает пользователю: "Configuration is valid".
    *   **Failure**: `uv` выводит граф конфликтов (например, `package A requires numpy<2, package B requires numpy>=2`). HPM транслирует эту ошибку пользователю.

### 2.2. Почему это работает?
*   `uv lock` — это чистая математическая операция разрешения графа версий. Она очень быстрая (благодаря кэшированию метаданных PyPI).
*   Она не требует скачивания wheel-файлов (только метаданных).
*   Она гарантирует, что если `uv sync` будет запущен позже, он пройдет успешно (с точки зрения версий).

## 3. Интеграция в CLI

```bash
hpm check --group inference --option vlm-adapter-qwen
```

### Логика:
1.  Создать виртуальный `pyproject.toml` с `dependencies = ["vlm-adapter-qwen"]`.
2.  Запустить `uv lock`.
3.  Если ОК -> Вывести "Ready to install".

## 4. Продвинутая валидация (Compatibility Matrix)

В будущем реестр HPM может содержать явную матрицу совместимости:

```yaml
# registry/groups/inference.yaml
options:
  - name: "vlm-adapter-qwen"
    conflicts:
      - "metric-legacy-v1" # Несовместим со старой метрикой
```

HPM будет проверять эти правила **до** вызова `uv lock`, давая мгновенную обратную связь на уровне бизнес-логики.