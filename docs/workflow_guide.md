# HPM Workflow Guide: Dev vs Prod

Этот документ описывает рабочий процесс (Workflow) разработки модульных приложений с использованием **Hyper Package Manager (HPM)**.

HPM позволяет разрабатывать проект, состоящий из множества независимых python-пакетов (плагинов), переключаясь между локальной разработкой (`dev`) и их стабильными релизами (`prod`) одной командой.

## Концепция

*   **Core (Ядро)**: Основной репозиторий, содержащий бизнес-логику и интерфейсы.
*   **Plugins (Плагины)**: Отдельные python-пакеты, реализующие интерфейсы ядра.
*   **HPM Registry**: Локальная или удаленная база знаний о том, где брать код плагинов.

## Сценарии

### 1. Режим разработки (Dev Mode)

**Цель**: Разрабатывать Ядро и Плагины одновременно, имея возможность менять код плагина "на лету".

**Структура на диске**:
```text
project-root/
├── hpm.yaml        # Манифест желаемого окружения (что мы хотим тестировать)
├── pyproject.toml  # Реальное описание проекта, управляемое HPM и реализуемое uv
├── src/            # Код ядра
└── packages/       # (Опционально) Папка для локальных клонов репозиториев плагинов
    ├── plugin-a/   # Отдельный git repo
    └── plugin-b/   # Отдельный git repo
```

> **Примечание**: Папка `packages/` — это лишь пример. HPM позволяет указывать любой путь к локальному пакету в конфигурации (напрмер `../my-libs/lib-a`). 

HPM не задает требований и стремится предоставить удобство разработчикам. Чтобы вы организовывали рабочее пространство вашего проекта так, как удобно вам.

**Как это работает**:
1.  Вы клонируете репозитории плагинов в папку `packages/` (или любую другую) как обычные git-репозитории.
    *   *Преимущество*: Основной репозиторий проекта не засоряется кодом плагинов и не привязывается к ним жестко.
    *   *Изоляция*: Каждый плагин имеет свою собственную историю git.
    *   *Гибкость*: Легко добавить или удалить плагин для экспериментов.

> **Важно**: Использование `git submodules` считается **антипаттерном** при работе с HPM. 

Submodules создают жесткую связность версий и усложняют управление репозиторием. HPM берет на себя задачу связывания кода (через `pyproject.toml` и `uv`), оставляя Git-репозитории независимыми.

2.  В реестре HPM для пакета указан источник `local` с `editable: true`.
3.  При запуске `hpm sync`, HPM читает `hpm.yaml` и обновляет `pyproject.toml`, говоря `uv`: "Установи зависимость `plugin-a` как ссылку на папку `packages/plugin-a`".
4.  Любые изменения в `packages/plugin-a` мгновенно видны в Ядре без переустановки.

### 2. Режим эксплуатации (Prod Mode)

**Цель**: Собрать стабильное, воспроизводимое окружение для деплоя.

**Как это работает**:
1.  Вы переключаете режим: `export RUN_MODE=prod` (или флаг в CLI).
2.  В реестре HPM для пакета указан источник `git` (с конкретным тегом) или `pypi`.
3.  При запуске `hpm sync`, HPM говорит `uv`: "Установи зависимость `plugin-a` версии `1.2.0` из PyPI".
4.  Папка с пакетами (напрмер, `packages/`) не используется. Код скачивается и устанавливается в `site-packages`.

## Пример конфигурации (Registry Manifest)

```yaml
# hpm-registry/packages/rag4code-qdrant.yaml
name: rag4code-qdrant
sources:
  # Режим разработки: используем локальную папку
  dev:
    type: local
    path: ./packages/rag4code-qdrant
    editable: true
    
  # Режим продакшена: используем Git тег
  prod:
    type: git
    url: https://github.com/rag4code/adapter-qdrant.git
    ref: v1.0.0
```

## Пошаговый Workflow разработчика

1.  **Инициализация**:
    ```bash
    git clone <core-repo>
    cd core-repo
    # Создаем папку для локальных плагинов
    mkdir packages
    ```

2.  **Добавление плагина для доработки**:
    ```bash
    cd packages
    git clone <plugin-repo> rag4code-qdrant
    cd ..
    ```

3.  **Включение плагина в проект**:
    ```bash
    # Говорим HPM использовать этот плагин
    hpm group add vector-db --option rag4code-qdrant
    ```

4.  **Синхронизация окружения**:
    ```bash
    # HPM настраивает виртуальное окружение, связывая Core и локальный Плагин
    hpm sync
    ```

5.  **Кодинг**:
    *   Меняем код в `src/` (Core).
    *   Меняем код в `packages/rag4code-qdrant/` (Plugin).
    *   Запускаем тесты — проверяем как все работает вместе.

6.  **Релиз**:
    *   Коммитим и пушим изменения в репо плагина. Создаем тег `v1.1.0`.
    *   Обновляем манифест в реестре HPM (указываем `ref: v1.1.0` для prod).
    *   Тестируем все вместе снова.
    *   Коммитим изменения в Core, создаем релиз проекта.