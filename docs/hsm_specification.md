# Specification: Hyper Stack Manager (hsm)

## 1. Vision
**hsm** — это Meta-Orchestrator для современной разработки, выступающий в роли "Environment Hypervisor". Он позволяет декларативно собирать рабочее окружение проекта из независимых компонентов (Python-пакетов и Docker-контейнеров) на основе единого манифеста.

HSM решает проблему управления сложными, модульными системами, предоставляя уровень абстракции над инструментами установки (`uv`, `pixi`, `docker`).

## 2. Core Concepts

### 2.1. Declarative Intent (hsm.yaml)
В отличие от императивных команд установки, HSM использует файл `hsm.yaml` как единственный источник правды (Source of Truth). Разработчик описывает *что* он хочет видеть в проекте, а HSM берет на себя задачу *как* это реализовать.

### 2.2. Meta-Orchestration & Adapters
HSM не заменяет существующие инструменты, а оркестрирует их через систему адаптеров:
*   **Python Adapter (uv/pixi)**: Управляет зависимостями в `pyproject.toml`.
*   **Docker Adapter**: Управляет сервисами через генерацию `docker-compose.hsm.yml`.

### 2.3. Hybrid Environment (Python + Docker)
HSM позволяет одновременно управлять и библиотечным кодом, и инфраструктурными сервисами. Это обеспечивает бесшовную интеграцию: например, вы выбираете в манифесте реализацию векторной БД, и HSM одновременно подтягивает нужный Python-клиент и разворачивает соответствующий контейнер.

### 2.4. Dev vs Prod (Seamless Transition)
HSM нативно поддерживает переключение режимов:
*   **Prod**: Использует стабильные артефакты (PyPI пакеты, готовые Docker-образы из Registry).
*   **Dev**: Переключает компоненты на локальные исходники (Editable installs для Python, `build` контексты и `volumes` для Docker).

### 2.5. Advanced Selection (1-of-N / M-of-N)
Механизм групп в Реестре позволяет определять интерфейсы. Пользователь выбирает одну из нескольких реализаций (например, Qdrant vs Milvus), и HSM автоматически перестраивает всё окружение под этот выбор.

## 3. Architecture

### 3.1. Components
1.  **HSMCore (Facade)**: Единая точка входа, оркестрирующая работу подсистем.
2.  **Registry Manager**: Справочник доступных компонентов, разделенный на `packages`, `containers` и `groups`.
3.  **Sync Engine**: "Мозг" системы, отвечающий за разрешение зависимостей и **Implication Merging**.
4.  **Manifest Engine**: Управляет файлом `hsm.yaml`, обеспечивая атомарность изменений и сохранение комментариев (Round-Trip).
5.  **Validator**: Выполняет dry-run проверки целостности проекта.
6.  **Adapter Layer**: Транслирует намерения из манифеста в конфигурации для `uv`, `docker compose` и других инструментов.

## 4. Key Advantages
*   **Atomic Sync**: Изменения применяются транзакционно. Если зависимости не сошлись, основные конфиги проекта (`pyproject.toml`, `docker-compose.yml`) остаются нетронутыми.
*   **No Hard Dependencies**: Избавляет от `git submodules`. Код плагинов подтягивается динамически только тогда, когда он нужен.
*   **Unified DX**: Единый CLI для управления всем стеком технологий проекта.
