# ADR 003: Декларативный манифест и архитектура адаптеров

## Статус
Proposed

## Контекст
Текущая реализация HPM (Hyper Package Manager) имеет несколько ограничений:
1. Команды CLI перемешаны (управление реестром и проектом находятся на одном уровне).
2. Отсутствует четкое разделение между "намерением" (какие пакеты нужны) и "реализацией" (как их установить).
3. Система жестко завязана на `uv`, что затрудняет поддержку других инструментов, таких как `pixi` или классический `pip`.
4. В сценариях CI/CD требуется воспроизводимость на основе статического манифеста.

## Решение
Мы переходим к декларативной модели управления конфигурацией, основанной на стандартах 2026 года (IaC, GitOps).

### 1. Единый манифест в `pyproject.toml`
Вместо отдельного файла `hpm.yaml` (или в дополнение к нему как опция), основным источником правды для проекта становится секция `[tool.hpm]` в `pyproject.toml`.

**Пример:**
```toml
[tool.hpm]
manager = "uv" # По умолчанию

[tool.hpm.groups]
inference = "vlm-adapter-qwen"
metrics = ["accuracy", "latency"]
```

### 2. Архитектура адаптеров (Backend Agnostic)
Вводится абстракция "Адаптер пакетного менеджера". HPM выступает в роли оркестратора, который транслирует высокоуровневые намерения из `[tool.hpm]` в команды конкретного инструмента.

*   **UvAdapter**: Обновляет `[project.dependencies]` и вызывает `uv sync`.
*   **PixiAdapter (План)**: Обновляет `[tool.pixi.dependencies]` и вызывает `pixi install`.
*   **PipAdapter (План)**: Генерирует `requirements.txt` или вызывает `pip install`.

### 3. Реорганизация CLI
Команды разделяются на логические группы:
*   **Project**: `init`, `sync`, `check`, `list` (управление состоянием проекта).
*   **Edit**: `add`, `remove` (редактирование манифеста `pyproject.toml`).
*   **Registry**: `registry search`, `registry show`, `registry add` (справочная информация).

## Последствия
*   **Плюсы**:
    *   Полная совместимость с экосистоямой Python (PEP 518/621).
    *   Легкая расширяемость для поддержки новых пакетных менеджеров.
    *   Прозрачность для CI/CD через `hpm sync --frozen`.
*   **Минусы**:
    *   Необходимость миграции существующей логики в `cli.py` и `core.py`.